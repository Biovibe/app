<div class="mystress-content">
    <!-- Date Navigation -->
    <div class="date-navigation">
        <button class="nav-arrow" id="prev-date">&#8249;</button>
        <div class="date-display" id="date-display">
            <span class="current-date" id="current-date">Today</span>
            <span class="dropdown-arrow">&#9662;</span>
        </div>
        <button class="nav-arrow" id="next-date">&#8250;</button>
    </div>

    <!-- Date Picker Modal -->
    <div class="date-picker-modal" id="date-picker-modal">
        <div class="date-picker-content">
            <input type="date" id="date-picker" />
            <div class="date-picker-buttons">
                <button id="date-picker-cancel">Cancel</button>
                <button id="date-picker-confirm">Select</button>
            </div>
        </div>
    </div>

    <!-- Time Period Selector -->
    <div class="time-period-selector">
        <button class="period-btn active" data-period="day" id="period-day">Day</button>
        <button class="period-btn" data-period="week" id="period-week">Week</button>
        <button class="period-btn" data-period="month" id="period-month">Month</button>
    </div>

    <!-- Stress Level Chart -->
    <div class="chart-container">
        <div class="chart-header">
            <h3>Stress Level Monitoring</h3>
            <div class="chart-controls">
                <button class="control-btn pause-btn" id="pause-resume-btn">
                    <span class="btn-icon">⏸️</span>
                    <span class="btn-text">Pause</span>
                </button>
                <div id="connection-status" class="status disconnected">Disconnected</div>
            </div>
        </div>
        <div id="stress-chart" class="stress-chart"></div>
        <div class="chart-info">
            <div class="current-reading">
                <span class="label">Current Level:</span>
                <span id="current-stress-level" class="value">--</span>
            </div>
            <div class="session-stats">
                <div class="stat">
                    <span class="stat-label">Average:</span>
                    <span id="avg-stress" class="stat-value">--</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Peak:</span>
                    <span id="peak-stress" class="stat-value">--</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Duration:</span>
                    <span id="session-duration" class="stat-value">00:00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.mystress-content {
    padding: 15px;
    background: var(--light-lavender);
    min-height: calc(100vh - 200px); /* Account for header and footer */
    max-height: calc(100vh - 200px); /* Prevent overflow */
    overflow-y: auto; /* Allow scrolling if needed */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.date-navigation {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    flex-shrink: 0; /* Don't shrink this element */
}

.nav-arrow {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--dark-grey);
    cursor: pointer;
    padding: 10px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.nav-arrow:hover {
    background: var(--greyish-purple);
    color: var(--purple);
}

.date-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--black);
    cursor: pointer;
    flex: 1;
    text-align: center;
}

.dropdown-arrow {
    color: var(--purple);
    font-size: 0.8rem;
}

.time-period-selector {
    display: flex;
    justify-content: center;
    gap: 5px;
    flex-shrink: 0; /* Don't shrink this element */
}

.period-btn {
    padding: 8px 20px;
    border: none;
    background: var(--white);
    color: var(--dark-grey);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.period-btn.active {
    background: var(--purple);
    color: var(--white);
}

.period-btn:hover:not(.active) {
    background: var(--greyish-purple);
}

/* Chart Container Styles */
.chart-container {
    background: var(--white);
    border-radius: 15px;
    margin: 15px 0;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    flex: 1; /* Take up remaining space */
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow shrinking */
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--light-grey);
}

.chart-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.chart-header h3 {
    margin: 0;
    color: var(--black);
    font-size: 1.4rem;
}

.control-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    font-weight: 500;
}

.pause-btn {
    background: var(--purple);
    color: var(--white);
}

.pause-btn:hover {
    background: var(--dark-purple);
}

.pause-btn.paused {
    background: #4CAF50;
}

.pause-btn.paused:hover {
    background: #45a049;
}

.btn-icon {
    font-size: 1rem;
}

.btn-text {
    font-size: 0.85rem;
}

.status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    text-transform: uppercase;
}

.status.connected {
    background: #e8f5e8;
    color: #4CAF50;
}

.status.disconnected {
    background: #ffeaea;
    color: #f44336;
}

.stress-chart {
    width: 100%;
    height: min(400px, calc(100vh - 400px)); /* Responsive height that fits viewport */
    min-height: 250px; /* Minimum usable height */
    margin: 15px 0;
}

.chart-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--light-grey);
}

.current-reading {
    display: flex;
    align-items: center;
    gap: 10px;
}

.current-reading .label {
    color: var(--dark-grey);
    font-weight: bold;
}

.current-reading .value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--purple);
    padding: 5px 15px;
    background: var(--light-lavender);
    border-radius: 8px;
}

.session-stats {
    display: flex;
    gap: 20px;
}

.stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--dark-grey);
    margin-bottom: 5px;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--black);
}

/* Date Picker Modal */
.date-picker-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.date-picker-modal.show {
    display: flex;
}

.date-picker-content {
    background: var(--white);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.date-picker-content input[type="date"] {
    width: 200px;
    padding: 12px;
    border: 2px solid var(--greyish-purple);
    border-radius: 8px;
    font-size: 1rem;
    margin-bottom: 20px;
    outline: none;
    transition: border-color 0.3s ease;
    text-align: center;
}

.date-picker-content input[type="date"]:focus {
    border-color: var(--purple);
}

.date-picker-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.date-picker-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

#date-picker-cancel {
    background: var(--light-grey);
    color: var(--dark-grey);
}

#date-picker-cancel:hover {
    background: var(--greyish-purple);
}

#date-picker-confirm {
    background: var(--purple);
    color: var(--white);
}

#date-picker-confirm:hover {
    background: var(--dark-purple);
}

/* Enhanced date display cursor */
.date-display {
    cursor: pointer;
    transition: all 0.3s ease;
}

.date-display:hover {
    color: var(--purple);
}

/* Responsive design */
@media (max-width: 768px) {
    .mystress-content {
        padding: 10px;
        gap: 10px;
        min-height: calc(100vh - 180px); /* Adjust for mobile */
        max-height: calc(100vh - 180px);
    }
    
    .date-navigation {
        gap: 15px;
    }
    
    .date-display {
        font-size: 1rem;
    }
    
    .period-btn {
        padding: 6px 15px;
        font-size: 0.8rem;
    }
    
    .chart-container {
        padding: 10px;
        margin: 0;
    }
    
    .chart-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
        margin-bottom: 10px;
        padding-bottom: 10px;
    }
    
    .chart-header h3 {
        font-size: 1.2rem;
    }
    
    .chart-controls {
        gap: 10px;
        align-self: stretch;
        justify-content: space-between;
    }
    
    .control-btn {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    
    .stress-chart {
        height: min(300px, calc(100vh - 350px)); /* Smaller on mobile */
        min-height: 200px;
        margin: 10px 0;
    }
    
    .chart-info {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .session-stats {
        gap: 15px;
        width: 100%;
        justify-content: space-around;
    }
    
    .current-reading .value {
        font-size: 1.3rem;
    }
}
</style>

<script>
// Add Plotly.js library
const plotlyScript = document.createElement('script');
plotlyScript.src = 'https://cdn.plot.ly/plotly-latest.min.js';
document.head.appendChild(plotlyScript);

// Global variables
let currentDate = new Date();
let currentPeriod = 'day';

// Chart variables
let stressTimeData = [];
let stressValueData = [];
let sessionStartTime = Date.now();
let sessionStats = {
    average: 0,
    peak: 0,
    current: 0,
    count: 0,
    sum: 0
};

// WebSocket connection
let stressSocket = null;

// Pause state
let isPaused = false;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    updateDateDisplay();
    initializeEventListeners();
    initializePauseButton();
    initializeStressChart();
    connectToStressMonitor();
});

// Update the date display text
function updateDateDisplay() {
    const dateElement = document.getElementById('current-date');
    const today = new Date();
    
    // Format the date based on the current period
    if (currentPeriod === 'day') {
        // Always show the formatted date, including "Today, Month Day" for today
        dateElement.textContent = formatDate(currentDate);
    } else if (currentPeriod === 'week') {
        const weekRange = getWeekRange(currentDate);
        dateElement.textContent = `${formatShortDate(weekRange.start)} - ${formatShortDate(weekRange.end)}`;
    } else if (currentPeriod === 'month') {
        dateElement.textContent = formatMonth(currentDate);
    }
}

// Format date as "Today, Jun 3" or "Monday, Jun 3"
function formatDate(date) {
    const today = new Date();
    const options = { weekday: 'long', month: 'short', day: 'numeric' };
    
    if (isSameDay(date, today)) {
        return 'Today, ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } else {
        return date.toLocaleDateString('en-US', options);
    }
}

// Format short date as "Jun 3"
function formatShortDate(date) {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Format month as "June 2024"
function formatMonth(date) {
    return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

// Check if two dates are the same day
function isSameDay(date1, date2) {
    return date1.toDateString() === date2.toDateString();
}

// Get week range (Sunday to Saturday)
function getWeekRange(date) {
    const start = new Date(date);
    const day = start.getDay();
    const diff = start.getDate() - day;
    
    start.setDate(diff);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    
    return { start, end };
}

// Initialize all event listeners
function initializeEventListeners() {
    // Date navigation arrows
    document.getElementById('prev-date').addEventListener('click', function() {
        navigateDate(-1);
    });
    
    document.getElementById('next-date').addEventListener('click', function() {
        navigateDate(1);
    });
    
    // Date display click (show date picker)
    document.getElementById('date-display').addEventListener('click', function() {
        showDatePicker();
    });
    
    // Period buttons
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            changePeriod(this.dataset.period);
        });
    });
    
    // Date picker modal
    document.getElementById('date-picker-cancel').addEventListener('click', function() {
        hideDatePicker();
    });
    
    document.getElementById('date-picker-confirm').addEventListener('click', function() {
        confirmDateSelection();
    });
    
    // Close modal when clicking outside
    document.getElementById('date-picker-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideDatePicker();
        }
    });
}

// Navigate date by increment based on current period
function navigateDate(increment) {
    if (currentPeriod === 'day') {
        currentDate.setDate(currentDate.getDate() + increment);
    } else if (currentPeriod === 'week') {
        currentDate.setDate(currentDate.getDate() + (increment * 7));
    } else if (currentPeriod === 'month') {
        currentDate.setMonth(currentDate.getMonth() + increment);
    }
    
    updateDateDisplay();
    // Reset stress session when date changes
    resetStressSession();
    console.log('Date changed to:', currentDate, 'Period:', currentPeriod);
}

// Change the time period (day/week/month)
function changePeriod(newPeriod) {
    // Update active button
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('period-' + newPeriod).classList.add('active');
    
    currentPeriod = newPeriod;
    updateDateDisplay();
    
    // Reset stress session when period changes
    resetStressSession();
    console.log('Period changed to:', currentPeriod);
}

// Show the date picker modal
function showDatePicker() {
    const modal = document.getElementById('date-picker-modal');
    const datePicker = document.getElementById('date-picker');
    
    // Set the date picker to current date
    datePicker.value = currentDate.toISOString().split('T')[0];
    
    modal.classList.add('show');
}

// Hide the date picker modal
function hideDatePicker() {
    const modal = document.getElementById('date-picker-modal');
    modal.classList.remove('show');
}

// Confirm date selection from picker
function confirmDateSelection() {
    const datePicker = document.getElementById('date-picker');
    const selectedDate = new Date(datePicker.value + 'T00:00:00');
    
    if (selectedDate && !isNaN(selectedDate.getTime())) {
        currentDate = selectedDate;
        updateDateDisplay();
        hideDatePicker();
        
        // Reset stress session when date is manually selected
        resetStressSession();
        console.log('Date selected:', currentDate);
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        navigateDate(-1);
    } else if (e.key === 'ArrowRight') {
        navigateDate(1);
    } else if (e.key === 'Escape') {
        hideDatePicker();
    }
});

// Initialize stress monitoring chart
function initializeStressChart() {
    plotlyScript.onload = function() {
        const plotData = [{
            x: stressTimeData,
            y: stressValueData,
            type: 'scatter',
            mode: 'lines+markers',
            line: {color: '#8B5CF6', width: 3},
            marker: {size: 6, color: '#8B5CF6'},
            name: 'Stress Level',
            fill: 'tonexty',
            fillcolor: 'rgba(139, 92, 246, 0.1)'
        }];

        const layout = {
            title: {
                text: 'Real-time Stress Monitoring',
                font: {size: 16, color: '#333'}
            },
            xaxis: {
                title: 'Time (seconds)',
                gridcolor: '#f0f0f0',
                showgrid: true
            },
            yaxis: {
                title: 'Stress Level',
                range: [0, 100],
                gridcolor: '#f0f0f0',
                showgrid: true
            },
            showlegend: false,
            margin: {l: 50, r: 30, t: 50, b: 50},
            plot_bgcolor: 'white',
            paper_bgcolor: 'white'
        };

        Plotly.newPlot('stress-chart', plotData, layout, {responsive: true});
    };
}

// Connect to stress monitoring WebSocket
function connectToStressMonitor() {
    const statusElement = document.getElementById('connection-status');
    
    try {
        // Use the same WebSocket server as the RandomNumGenerator
        stressSocket = new WebSocket('ws://127.0.0.1:8000');
        
        stressSocket.onopen = function() {
            console.log('Connected to stress monitoring server.');
            statusElement.textContent = 'Connected';
            statusElement.className = 'status connected';
            updateSessionDuration();
        };

        stressSocket.onmessage = function(event) {
            console.log('Stress data received:', event.data);
            
            // Skip processing if paused
            if (isPaused) {
                console.log('Data collection paused - ignoring incoming data');
                return;
            }
            
            // Parse the data (string of numbers separated by spaces)
            const numbers = event.data.split(' ').map(num => parseFloat(num)).filter(num => !isNaN(num));
            
            if (numbers.length > 0) {
                // Process each stress level reading
                numbers.forEach(value => {
                    addStressDataPoint(value);
                });
                
                updateStressChart();
                updateStressStats();
            }
        };

        stressSocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            statusElement.textContent = 'Connection Error';
            statusElement.className = 'status disconnected';
        };

        stressSocket.onclose = function() {
            console.log('Stress monitoring connection closed.');
            statusElement.textContent = 'Disconnected';
            statusElement.className = 'status disconnected';
            
            // Attempt to reconnect after 5 seconds
            setTimeout(connectToStressMonitor, 5000);
        };
        
    } catch (error) {
        console.error('Failed to connect to stress monitor:', error);
        statusElement.textContent = 'Connection Failed';
        statusElement.className = 'status disconnected';
    }
}

// Add a new stress data point
function addStressDataPoint(value) {
    const currentTime = (Date.now() - sessionStartTime) / 1000; // Convert to seconds
    
    stressTimeData.push(currentTime);
    stressValueData.push(value);
    
    // Update session stats
    sessionStats.current = value;
    sessionStats.count++;
    sessionStats.sum += value;
    sessionStats.average = sessionStats.sum / sessionStats.count;
    sessionStats.peak = Math.max(sessionStats.peak, value);
    
    // Keep only last 100 data points for performance
    if (stressTimeData.length > 100) {
        stressTimeData.shift();
        stressValueData.shift();
    }
}

// Update the stress chart
function updateStressChart() {
    if (typeof Plotly !== 'undefined' && document.getElementById('stress-chart')) {
        Plotly.update('stress-chart', {
            x: [stressTimeData],
            y: [stressValueData]
        });
        
        // Auto-scale the x-axis to show recent data
        if (stressTimeData.length > 20) {
            const recentTimes = stressTimeData.slice(-50);
            Plotly.relayout('stress-chart', {
                'xaxis.range': [recentTimes[0], recentTimes[recentTimes.length - 1]]
            });
        }
    }
}

// Update stress statistics display
function updateStressStats() {
    document.getElementById('current-stress-level').textContent = sessionStats.current.toFixed(1);
    document.getElementById('avg-stress').textContent = sessionStats.average.toFixed(1);
    document.getElementById('peak-stress').textContent = sessionStats.peak.toFixed(1);
}

// Update session duration
function updateSessionDuration() {
    // Only update duration if not paused
    if (!isPaused) {
        const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        
        document.getElementById('session-duration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Update every second if connected
    if (stressSocket && stressSocket.readyState === WebSocket.OPEN) {
        setTimeout(updateSessionDuration, 1000);
    }
}

// Reset session data when period changes
function resetStressSession() {
    stressTimeData = [];
    stressValueData = [];
    sessionStartTime = Date.now();
    sessionStats = {
        average: 0,
        peak: 0,
        current: 0,
        count: 0,
        sum: 0
    };
    
    // Clear the chart
    if (typeof Plotly !== 'undefined' && document.getElementById('stress-chart')) {
        Plotly.update('stress-chart', {
            x: [[]],
            y: [[]]
        });
    }
    
    // Reset stats display
    document.getElementById('current-stress-level').textContent = '--';
    document.getElementById('avg-stress').textContent = '--';
    document.getElementById('peak-stress').textContent = '--';
    document.getElementById('session-duration').textContent = '00:00';
    
    // Reset pause state
    isPaused = false;
    updatePauseButton();
}

// Initialize pause button
function initializePauseButton() {
    const pauseBtn = document.getElementById('pause-resume-btn');
    pauseBtn.addEventListener('click', togglePause);
    updatePauseButton();
}

// Toggle pause/resume state
function togglePause() {
    isPaused = !isPaused;
    updatePauseButton();
    
    if (isPaused) {
        console.log('Data collection paused');
        // Update chart title to show paused state
        if (typeof Plotly !== 'undefined' && document.getElementById('stress-chart')) {
            Plotly.relayout('stress-chart', {
                'title.text': 'Real-time Stress Monitoring (PAUSED)'
            });
        }
    } else {
        console.log('Data collection resumed');
        // Reset session start time to account for pause duration
        const currentTime = Date.now();
        const pauseDuration = currentTime - sessionStartTime - (stressTimeData.length * 1000); // Approximate
        sessionStartTime = currentTime - (stressTimeData.length * 1000);
        
        // Update chart title to show resumed state
        if (typeof Plotly !== 'undefined' && document.getElementById('stress-chart')) {
            Plotly.relayout('stress-chart', {
                'title.text': 'Real-time Stress Monitoring'
            });
        }
    }
}

// Update pause button appearance and text
function updatePauseButton() {
    const pauseBtn = document.getElementById('pause-resume-btn');
    const btnIcon = pauseBtn.querySelector('.btn-icon');
    const btnText = pauseBtn.querySelector('.btn-text');
    
    if (isPaused) {
        pauseBtn.classList.add('paused');
        btnIcon.textContent = '▶️';
        btnText.textContent = 'Resume';
    } else {
        pauseBtn.classList.remove('paused');
        btnIcon.textContent = '⏸️';
        btnText.textContent = 'Pause';
    }
}
</script>
